version: 2
jobs:
  build:
    docker:
      # CircleCI Go images available at: https://hub.docker.com/r/circleci/golang/
      - image: fpco/stack-build:lts-9.14
        user: stackage

    working_directory: /home/stackage

    environment:
      TEST_RESULTS: /tmp/test-results

    steps:
      - checkout
      - restore_cache:
          key: v2-cache

      - run: stack build --test --only-dependencies --no-terminal --system-ghc
      - save_cache:
          key: v2-cache
          paths:
            - /home/stackage/.stack
      - run: stack install --test --no-terminal --system-ghc
      - store_artifacts:
          path: .local/bin/demo-exe
          destination: raw-test-output
      - store_test_results:
          path: .stack-work/logs/*
